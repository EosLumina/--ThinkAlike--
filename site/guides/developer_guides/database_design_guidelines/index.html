<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://eoslumina.github.io/--ThinkAlike--/guides/developer_guides/database_design_guidelines/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Database Design Guidelines - ThinkAlike Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Database Design Guidelines";
        var mkdocs_page_input_path = "guides/developer_guides/database_design_guidelines.md";
        var mkdocs_page_url = "/--ThinkAlike--/guides/developer_guides/database_design_guidelines/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> ThinkAlike Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../../index.md">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Core</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../core/enlightenment_2_0/enlightenment_2_0_principles/">Enlightenment 2.0 Principles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../core/ethics/ethical_guidelines/">Ethical Guidelines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../core/contributing/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../core/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../core/onboarding_guide/">Onboarding Guide</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Vision</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../vision/core_concepts/">Core Concepts Explained</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../vision/blockchain_integration/">Blockchain Integration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architecture</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/architectural_overview/">Architectural Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/api/api_endpoints_mode2/">API Endpoints (Mode 2)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../code_style_guide/">Code Style Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../building_backend_endpoint/">Building Backend Endpoint Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../building_ui_component/">Building UI Component Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ui_validation_examples/">UI Validation Examples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../git_workflow/">Git Workflow Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/github_actions_workflow_format.md">GitHub Actions Workflow Format</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DevOps</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../devops/devops_workflow.md">DevOps Workflow Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../devops/ci_cd_workflow_reference.md">CI/CD Workflow Reference</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">ThinkAlike Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Database Design Guidelines</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="database-design-guidelines">Database Design Guidelines</h1>
<hr />
<h2 id="1-introduction">1. Introduction</h2>
<p>Defines database design patterns, best practices, and standards for ensuring data consistency and performance.</p>
<hr />
<h2 id="2-database-architecture">2. Database Architecture</h2>
<h3 id="21-schema-design">2.1 Schema Design</h3>
<div class="highlight"><pre><span></span><code>erDiagram
    USER {
        uuid id PK
        string email
        string password_hash
        timestamp created_at
    }
    PROFILE {
        uuid id PK
        uuid user_id FK
        jsonb preferences
    }
    USER ||--o| PROFILE : has
</code></pre></div>
<hr />
<h2 id="2-database-design-principles">2. Database Design Principles</h2>
<h3 id="21-core-principles">2.1 Core Principles</h3>
<ul>
<li>
<p><strong>Single Source of Truth</strong>: Store each piece of data in one place</p>
</li>
<li>
<p><strong>Normalization</strong>: Structure data to minimize redundancy</p>
</li>
<li>
<p><strong>Performance</strong>: Design for query efficiency and scalability</p>
</li>
<li>
<p><strong>Integrity</strong>: Enforce data consistency through constraints</p>
</li>
<li>
<p><strong>Security</strong>: Apply the principle of least privilege</p>
</li>
<li>
<p><strong>Maintainability</strong>: Design for clarity and ease of modification</p>
</li>
</ul>
<h3 id="22-technology-choices">2.2 Technology Choices</h3>
<p>ThinkAlike uses the following database technologies:</p>
<ul>
<li>
<p><strong>Primary Database</strong>: PostgreSQL (relational)</p>
</li>
<li>
<p><strong>Caching Layer</strong>: Redis</p>
</li>
<li>
<p><strong>Search Engine</strong>: Elasticsearch</p>
</li>
<li>
<p><strong>Time-Series Data</strong>: InfluxDB (for metrics and analytics)</p>
</li>
<li>
<p><strong>Graph Relationships</strong>: Neo4j (for social/connection features)</p>
</li>
</ul>
<hr />
<h2 id="3-schema-design">3. Schema Design</h2>
<h3 id="31-naming-conventions">3.1 Naming Conventions</h3>
<ul>
<li>
<p>Use <strong>snake_case</strong> for all database objects (tables, columns, indexes)</p>
</li>
<li>
<p>Use <strong>plural nouns</strong> for table names (e.g., <code>users</code>, <code>preferences</code>)</p>
</li>
<li>
<p>Use <strong>singular nouns</strong> for column names (e.g., <code>first_name</code>, <code>created_at</code>)</p>
</li>
<li>
<p>Prefix join tables with joined table names (e.g., <code>users_teams</code>)</p>
</li>
<li>
<p>Use consistent prefixes for related tables</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example of proper naming conventions</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">teams</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users_teams</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">team_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">teams</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="k">role</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;member&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">joined_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">team_id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="32-data-types">3.2 Data Types</h3>
<ul>
<li>
<p>Choose the <strong>most appropriate data type</strong> for each column</p>
</li>
<li>
<p>Use <strong>fixed-length</strong> types when the length is known</p>
</li>
<li>
<p>Consider <strong>storage requirements</strong> and <strong>query performance</strong></p>
</li>
<li>
<p>Use <strong>domain-specific types</strong> when available (e.g., UUID, JSONB, ARRAY)</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Data Category</th>
<th>Preferred Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Identifiers</td>
<td>INTEGER, BIGINT, UUID</td>
<td>Use UUID for distributed systems</td>
</tr>
<tr>
<td>Short Text</td>
<td>VARCHAR(n)</td>
<td>Specify appropriate length</td>
</tr>
<tr>
<td>Long Text</td>
<td>TEXT</td>
<td>For variable-length content</td>
</tr>
<tr>
<td>Dates and Times</td>
<td>TIMESTAMP WITH TIME ZONE</td>
<td>Always store in UTC</td>
</tr>
<tr>
<td>Booleans</td>
<td>BOOLEAN</td>
<td>Not NULL with default</td>
</tr>
<tr>
<td>Floating Point</td>
<td>NUMERIC</td>
<td>For financial calculations</td>
</tr>
<tr>
<td>Enumerated Values</td>
<td>ENUM or CHECK constraint</td>
<td>For fixed sets of values</td>
</tr>
<tr>
<td>JSON Data</td>
<td>JSONB</td>
<td>For flexible schema content</td>
</tr>
<tr>
<td>Binary Data</td>
<td>BYTEA</td>
<td>For files, consider external storage</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example proper data type usage</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">content_items</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">body</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;draft&#39;</span>
<span class="w">        </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;published&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;archived&#39;</span><span class="p">)),</span>
<span class="w">    </span><span class="n">view_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">metadata</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">published_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="33-relationships">3.3 Relationships</h3>
<ul>
<li>
<p>Define <strong>foreign keys</strong> to enforce referential integrity</p>
</li>
<li>
<p>Consider <strong>cascading operations</strong> for related data</p>
</li>
<li>
<p>Use <strong>join tables</strong> for many-to-many relationships</p>
</li>
<li>
<p>Include <strong>relationship metadata</strong> when needed (e.g., role, status)</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example relationships</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">content_item_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">content_items</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">parent_comment_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">comments</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">content</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_comments_content_item</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">comments</span><span class="p">(</span><span class="n">content_item_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_comments_user</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">comments</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_comments_parent</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">comments</span><span class="p">(</span><span class="n">parent_comment_id</span><span class="p">);</span>
</code></pre></div>
<hr />
<h2 id="4-indexing-strategy">4. Indexing Strategy</h2>
<h3 id="41-index-types">4.1 Index Types</h3>
<ul>
<li>
<p><strong>Primary Key</strong>: Define for all tables</p>
</li>
<li>
<p><strong>Unique Index</strong>: For columns with uniqueness constraints</p>
</li>
<li>
<p><strong>Foreign Key Index</strong>: Create indexes for all foreign keys</p>
</li>
<li>
<p><strong>Composite Index</strong>: For queries with multiple conditions</p>
</li>
<li>
<p><strong>Partial Index</strong>: For filtering on specific values</p>
</li>
<li>
<p><strong>Expression Index</strong>: For transformed data lookups</p>
</li>
</ul>
<h3 id="42-indexing-guidelines">4.2 Indexing Guidelines</h3>
<ul>
<li>
<p>Index columns used in <strong>WHERE, JOIN, and ORDER BY</strong> clauses</p>
</li>
<li>
<p>Consider the <strong>selectivity</strong> of the indexed columns</p>
</li>
<li>
<p>Balance between <strong>query performance</strong> and <strong>write overhead</strong></p>
</li>
<li>
<p>Monitor and adjust indexes based on <strong>query patterns</strong></p>
</li>
<li>
<p>Name indexes consistently: <code>idx_[table]_[column(s)]</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example indexing strategy</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_activities</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">activity_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">entity_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">entity_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">data</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">ip_address</span><span class="w"> </span><span class="n">INET</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Index for user-specific activity queries</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_user_activities_user_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_activities</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>

<span class="c1">-- Composite index for filtered activity queries</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_user_activities_type_entity</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_activities</span><span class="p">(</span><span class="n">activity_type</span><span class="p">,</span><span class="w"> </span><span class="n">entity_type</span><span class="p">,</span><span class="w"> </span><span class="n">entity_id</span><span class="p">);</span>

<span class="c1">-- Index for recent activity queries</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_user_activities_created_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_activities</span><span class="p">(</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>

<span class="c1">-- Partial index for specific activity types</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_user_activities_logins</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_activities</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">activity_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;login&#39;</span><span class="p">;</span>

<span class="c1">-- Expression index for JSON queries</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_user_activities_data_source</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_activities</span><span class="p">((</span><span class="k">data</span><span class="o">-&gt;&gt;</span><span class="s1">&#39;source&#39;</span><span class="p">));</span>
</code></pre></div>
<h3 id="43-index-monitoring">4.3 Index Monitoring</h3>
<ul>
<li>
<p>Regularly review index usage statistics</p>
</li>
<li>
<p>Identify missing or unused indexes</p>
</li>
<li>
<p>Rebuild indexes periodically to reduce fragmentation</p>
</li>
<li>
<p>Consider index maintenance during off-peak hours</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Query to find unused indexes</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">schemaname</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">relname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">tablename</span><span class="p">,</span>
<span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">indexrelname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">indexname</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">index_size</span><span class="p">,</span>
<span class="w">    </span><span class="n">idx_scan</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">index_scans</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">pg_stat_user_indexes</span><span class="w"> </span><span class="n">i</span>
<span class="k">JOIN</span>
<span class="w">    </span><span class="n">pg_stat_user_tables</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">relid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">relid</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="n">idx_scan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">-- Unused indexes</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>
<hr />
<h2 id="5-performance-optimization">5. Performance Optimization</h2>
<h3 id="51-query-optimization">5.1 Query Optimization</h3>
<ul>
<li>
<p>Write <strong>efficient queries</strong> that minimize data retrieval</p>
</li>
<li>
<p>Use <strong>appropriate joins</strong> instead of multiple queries</p>
</li>
<li>
<p>Apply <strong>filtering early</strong> in the query</p>
</li>
<li>
<p>Optimize <strong>sorting and grouping</strong> operations</p>
</li>
<li>
<p>Consider <strong>pagination</strong> for large result sets</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example optimized query with filtering, joining, and pagination</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">content_summary</span><span class="p">,</span>
<span class="w">    </span><span class="n">u</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">author_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">comment_count</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">posts</span><span class="w"> </span><span class="n">p</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">post_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;published&#39;</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">published_at</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">NOW</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;30 days&#39;</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">content_summary</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">username</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">published_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span>
</code></pre></div>
<h3 id="52-database-connection-management">5.2 Database Connection Management</h3>
<ul>
<li>
<p>Use <strong>connection pooling</strong> to manage database connections</p>
</li>
<li>
<p>Set appropriate <strong>pool sizes</strong> based on workload</p>
</li>
<li>
<p>Monitor <strong>connection usage</strong> and adjust as needed</p>
</li>
<li>
<p>Implement <strong>connection timeout</strong> and <strong>retry logic</strong></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example SQLAlchemy connection pool configuration</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="s2">&quot;postgresql://user:password@localhost/dbname&quot;</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="n">DATABASE_URL</span><span class="p">,</span>
    <span class="c1"># Connection pool settings</span>

    <span class="n">pool_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Maximum connections in pool</span>

    <span class="n">max_overflow</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>  <span class="c1"># Maximum overflow connections</span>

    <span class="n">pool_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>  <span class="c1"># Seconds to wait for connection</span>

    <span class="n">pool_recycle</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>  <span class="c1"># Recycle connections after 30 minutes</span>

    <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Set to True for query logging</span>

<span class="p">)</span>

<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</code></pre></div>
<h3 id="53-caching-strategy">5.3 Caching Strategy</h3>
<ul>
<li>
<p>Cache <strong>frequently accessed</strong> and <strong>slow-changing</strong> data</p>
</li>
<li>
<p>Implement <strong>cache invalidation</strong> strategies</p>
</li>
<li>
<p>Consider <strong>multi-level caching</strong> (application, distributed, database)</p>
</li>
<li>
<p>Monitor <strong>cache hit ratios</strong> and adjust caching policies</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example Redis caching implementation</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">redis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>

<span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cache_result</span><span class="p">(</span><span class="n">ttl_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cache function results in Redis.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Create a cache key based on function name and arguments</span>

            <span class="n">key_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
            <span class="n">key_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
            <span class="n">key_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&quot;cache:&quot;</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_parts</span><span class="p">)</span>

            <span class="c1"># Try to get from cache</span>

            <span class="n">cached_result</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached_result</span><span class="p">)</span>

            <span class="c1"># If not in cache, call the function</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Cache the result</span>

            <span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
                <span class="n">cache_key</span><span class="p">,</span>
                <span class="n">ttl_seconds</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="c1"># Usage example</span>

<span class="nd">@cache_result</span><span class="p">(</span><span class="n">ttl_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_recommendations</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Expensive database query to generate recommendations</span>

    <span class="c1"># ...</span>

    <span class="k">return</span> <span class="n">recommendations</span>
</code></pre></div>
<hr />
<h2 id="6-data-migration-and-evolution">6. Data Migration and Evolution</h2>
<h3 id="61-schema-migrations">6.1 Schema Migrations</h3>
<ul>
<li>
<p>Use a <strong>migration framework</strong> to manage schema changes</p>
</li>
<li>
<p>Write <strong>reversible migrations</strong> when possible</p>
</li>
<li>
<p>Separate <strong>data migrations</strong> from schema changes</p>
</li>
<li>
<p>Test migrations with <strong>production-like data volumes</strong></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example Alembic migration script</span>

<span class="sd">&quot;&quot;&quot;Add user preferences table</span>

<span class="sd">Revision ID: 3a7e8bcf01d2</span>
<span class="sd">Revises: 2b5ef815d23e</span>
<span class="sd">Create Date: 2023-04-10 14:27:32.651987</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>

<span class="c1"># revision identifiers</span>

<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;3a7e8bcf01d2&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;2b5ef815d23e&#39;</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="c1"># Create new table</span>

    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;user_preferences&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;preference_key&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;preference_value&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">server_default</span><span class="o">=</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;now()&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;updated_at&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">server_default</span><span class="o">=</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;now()&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKeyConstraint</span><span class="p">([</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;users.id&#39;</span><span class="p">],</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Create indexes</span>

    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;idx_user_preferences_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_preferences&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_unique_constraint</span><span class="p">(</span><span class="s1">&#39;uq_user_preferences_user_key&#39;</span><span class="p">,</span> <span class="s1">&#39;user_preferences&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;preference_key&#39;</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="c1"># Drop table and constraints</span>

    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="s1">&#39;idx_user_preferences_user_id&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;user_preferences&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="62-migration-best-practices">6.2 Migration Best Practices</h3>
<ul>
<li>
<p>Schedule migrations during <strong>low-traffic periods</strong></p>
</li>
<li>
<p>Implement <strong>zero-downtime migrations</strong> for production</p>
</li>
<li>
<p>Create <strong>backup points</strong> before major migrations</p>
</li>
<li>
<p>Monitor <strong>database performance</strong> during and after migrations</p>
</li>
<li>
<p>Have a <strong>rollback plan</strong> for failed migrations</p>
</li>
</ul>
<h3 id="63-versioning">6.3 Versioning</h3>
<ul>
<li>
<p>Maintain <strong>backward compatibility</strong> when possible</p>
</li>
<li>
<p>Document <strong>breaking changes</strong> thoroughly</p>
</li>
<li>
<p>Consider <strong>schema versioning</strong> for major changes</p>
</li>
<li>
<p>Use <strong>feature flags</strong> to gradually roll out changes</p>
</li>
</ul>
<hr />
<h2 id="7-database-security">7. Database Security</h2>
<h3 id="71-access-control">7.1 Access Control</h3>
<ul>
<li>
<p>Apply the <strong>principle of least privilege</strong></p>
</li>
<li>
<p>Create <strong>separate database users</strong> for different access patterns</p>
</li>
<li>
<p>Use <strong>role-based access control</strong></p>
</li>
<li>
<p>Revoke unnecessary permissions</p>
</li>
<li>
<p>Regularly audit database access</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example database role and permission setup</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_readonly</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_readwrite</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">app_admin</span><span class="p">;</span>

<span class="c1">-- Grant appropriate permissions</span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_readonly</span><span class="p">;</span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_readwrite</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="p">,</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_readwrite</span><span class="p">;</span>

<span class="c1">-- Grant admin permissions</span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_admin</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_admin</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_admin</span><span class="p">;</span>

<span class="c1">-- Create application users</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">app_api_user</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secure_password&#39;</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">app_readwrite</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">app_api_user</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">reporting_user</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;another_secure_password&#39;</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">app_readonly</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">reporting_user</span><span class="p">;</span>
</code></pre></div>
<h3 id="72-data-encryption">7.2 Data Encryption</h3>
<ul>
<li>
<p>Encrypt <strong>sensitive data</strong> at rest</p>
</li>
<li>
<p>Use <strong>transport layer security</strong> (TLS/SSL) for connections</p>
</li>
<li>
<p>Implement <strong>column-level encryption</strong> for PII</p>
</li>
<li>
<p>Store <strong>encryption keys</strong> separately from the data</p>
</li>
<li>
<p>Regularly rotate encryption keys</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example of column-level encryption function</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">pgcrypto</span><span class="p">;</span>

<span class="c1">-- Function to encrypt data</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">encrypt_pii</span><span class="p">(</span><span class="n">input_text</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">pgp_sym_encrypt</span><span class="p">(</span>
<span class="w">        </span><span class="n">input_text</span><span class="p">,</span>
<span class="w">        </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.encryption_key&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="w"> </span><span class="k">SECURITY</span><span class="w"> </span><span class="k">DEFINER</span><span class="p">;</span>

<span class="c1">-- Function to decrypt data</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">decrypt_pii</span><span class="p">(</span><span class="n">encrypted_text</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">pgp_sym_decrypt</span><span class="p">(</span>
<span class="w">        </span><span class="n">encrypted_text</span><span class="p">::</span><span class="n">bytea</span><span class="p">,</span>
<span class="w">        </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.encryption_key&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="w"> </span><span class="k">SECURITY</span><span class="w"> </span><span class="k">DEFINER</span><span class="p">;</span>

<span class="c1">-- Example table with encrypted columns</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customer_data</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">customer_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">ssn</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Will store encrypted value</span>
<span class="w">    </span><span class="n">credit_card_number</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Will store encrypted value</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Example usage</span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">customer_data</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">ssn</span><span class="p">,</span><span class="w"> </span><span class="n">credit_card_number</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="mi">123</span><span class="p">,</span>
<span class="w">    </span><span class="n">encrypt_pii</span><span class="p">(</span><span class="s1">&#39;123-45-6789&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="n">encrypt_pii</span><span class="p">(</span><span class="s1">&#39;4111-1111-1111-1111&#39;</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="73-auditing">7.3 Auditing</h3>
<ul>
<li>
<p>Enable <strong>database audit logging</strong></p>
</li>
<li>
<p>Track <strong>schema changes</strong></p>
</li>
<li>
<p>Monitor <strong>suspicious query patterns</strong></p>
</li>
<li>
<p>Implement <strong>row-level change tracking</strong></p>
</li>
<li>
<p>Store audit logs securely</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example audit trail implementation</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">audit_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="k">table_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">operation</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">record_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">old_data</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">new_data</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">changed_by</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">changed_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Example trigger function for auditing</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">audit_trigger_func</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">DECLARE</span>
<span class="w">    </span><span class="n">audit_row</span><span class="w"> </span><span class="n">audit_log</span><span class="p">;</span>
<span class="w">    </span><span class="n">include_old</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">;</span>
<span class="w">    </span><span class="n">include_new</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="n">audit_row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ROW</span><span class="p">(</span>
<span class="w">        </span><span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;audit_log_id_seq&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="n">TG_TABLE_NAME</span><span class="p">,</span>
<span class="w">        </span><span class="n">TG_OP</span><span class="p">,</span>
<span class="w">        </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Will be replaced with actual ID</span>
<span class="w">        </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Will hold old data if relevant</span>
<span class="w">        </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Will hold new data if relevant</span>
<span class="w">        </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.current_user&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">TRUE</span><span class="p">),</span>
<span class="w">        </span><span class="n">NOW</span><span class="p">()</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">record_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">old_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">OLD</span><span class="p">);</span>
<span class="w">    </span><span class="k">ELSIF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UPDATE&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">record_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">old_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">OLD</span><span class="p">);</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">NEW</span><span class="p">);</span>
<span class="w">    </span><span class="k">ELSIF</span><span class="w"> </span><span class="n">TG_OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;INSERT&#39;</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">record_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">        </span><span class="n">audit_row</span><span class="p">.</span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_jsonb</span><span class="p">(</span><span class="k">NEW</span><span class="p">);</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">audit_log</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">audit_row</span><span class="p">.</span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- Apply audit trigger to a table</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">user_audit</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">users</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">audit_trigger_func</span><span class="p">();</span>
</code></pre></div>
<hr />
<h2 id="8-database-maintenance-and-operations">8. Database Maintenance and Operations</h2>
<h3 id="81-backup-and-recovery">8.1 Backup and Recovery</h3>
<ul>
<li>
<p>Implement <strong>regular backups</strong> with verified restore procedures</p>
</li>
<li>
<p>Use <strong>point-in-time recovery</strong> capabilities</p>
</li>
<li>
<p>Define appropriate <strong>backup retention policies</strong></p>
</li>
<li>
<p>Test <strong>recovery procedures</strong> regularly</p>
</li>
<li>
<p>Store backups in <strong>geographically distributed locations</strong></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example PostgreSQL backup script</span>

<span class="c1"># !/bin/bash</span>

<span class="c1"># Configuration</span>

<span class="nv">DB_NAME</span><span class="o">=</span><span class="s2">&quot;thinkalike&quot;</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">&quot;/var/backups/postgres&quot;</span>
<span class="nv">TIMESTAMP</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s2">&quot;%Y%m%d_%H%M%S&quot;</span><span class="k">)</span>
<span class="nv">BACKUP_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">TIMESTAMP</span><span class="si">}</span><span class="s2">.sql.gz&quot;</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">/backup_log.txt&quot;</span>

<span class="c1"># Ensure backup directory exists</span>

mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span>

<span class="c1"># Execute backup</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting backup of </span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2"> at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="si">${</span><span class="nv">LOG_FILE</span><span class="si">}</span>
pg_dump<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-d<span class="w"> </span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="w"> </span>-F<span class="w"> </span>c<span class="w"> </span>-b<span class="w"> </span>-v<span class="w"> </span>-f<span class="w"> </span><span class="si">${</span><span class="nv">BACKUP_FILE</span><span class="si">}</span>.tmp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
mv<span class="w"> </span><span class="si">${</span><span class="nv">BACKUP_FILE</span><span class="si">}</span>.tmp<span class="w"> </span><span class="si">${</span><span class="nv">BACKUP_FILE</span><span class="si">}</span>

<span class="c1"># Check if backup was successful</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Backup completed successfully: </span><span class="si">${</span><span class="nv">BACKUP_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="si">${</span><span class="nv">LOG_FILE</span><span class="si">}</span>

<span class="w">    </span><span class="c1"># Cleanup old backups (keep last 14 days)</span>

<span class="w">    </span>find<span class="w"> </span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2">_*.sql.gz&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-mtime<span class="w"> </span>+14<span class="w"> </span>-delete
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Backup failed!&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="si">${</span><span class="nv">LOG_FILE</span><span class="si">}</span>
<span class="k">fi</span>
</code></pre></div>
<h3 id="82-monitoring-and-alerting">8.2 Monitoring and Alerting</h3>
<ul>
<li>
<p>Monitor <strong>database performance metrics</strong></p>
</li>
<li>
<p>Set up alerts for <strong>unusual activity patterns</strong></p>
</li>
<li>
<p>Track <strong>resource usage</strong> (CPU, memory, disk, connections)</p>
</li>
<li>
<p>Monitor <strong>long-running queries</strong></p>
</li>
<li>
<p>Check for <strong>deadlocks</strong> and <strong>lock contention</strong></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example Prometheus alerting rules for PostgreSQL</span>

<span class="nt">groups</span><span class="p">:</span>

<span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresqlAlerts</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>

<span class="w">  </span><span class="nt">* alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresqlHighConnections</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">expr</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (instance) (pg_stat_activity_count) &gt; 200</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">for</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">  </span><span class="w w-Error">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">PostgreSQL</span><span class="nv"> </span><span class="s">connections&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;PostgreSQL</span><span class="nv"> </span><span class="s">instance</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">connections&quot;</span>

<span class="w">  </span><span class="nt">* alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresqlSlowQueries</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">expr</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pg_stat_activity_max_tx_duration{datname!~&quot;template.*|postgres&quot;} &gt; 300</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">for</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2m</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">  </span><span class="w w-Error">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;PostgreSQL</span><span class="nv"> </span><span class="s">slow</span><span class="nv"> </span><span class="s">queries&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;PostgreSQL</span><span class="nv"> </span><span class="s">instance</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">running</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">database</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.datname</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">  </span><span class="nt">* alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresqlHighReplicationLag</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">expr</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pg_replication_lag &gt; 600</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">for</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">  </span><span class="w w-Error">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;PostgreSQL</span><span class="nv"> </span><span class="s">high</span><span class="nv"> </span><span class="s">replication</span><span class="nv"> </span><span class="s">lag&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;PostgreSQL</span><span class="nv"> </span><span class="s">replication</span><span class="nv"> </span><span class="s">lag</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">seconds</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<h3 id="83-database-health-checks">8.3 Database Health Checks</h3>
<ul>
<li>
<p>Implement <strong>automatic health checks</strong></p>
</li>
<li>
<p>Check for <strong>database corruption</strong></p>
</li>
<li>
<p>Analyze <strong>index fragmentation</strong></p>
</li>
<li>
<p>Run <strong>regular vacuum</strong> operations</p>
</li>
<li>
<p>Monitor <strong>table bloat</strong></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example health check queries</span>

<span class="c1">-- 1. Check for bloated tables</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">schemaname</span><span class="p">,</span>
<span class="w">    </span><span class="n">tablename</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">table_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">table_size</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">bloat_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bloat_size</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">bloat_size</span><span class="o">/</span><span class="n">table_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bloat_percentage</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">schemaname</span><span class="p">,</span>
<span class="w">        </span><span class="n">tablename</span><span class="p">,</span>
<span class="w">        </span><span class="n">pg_table_size</span><span class="p">(</span><span class="n">schemaname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tablename</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">table_size</span><span class="p">,</span>
<span class="w">        </span><span class="n">pg_table_size</span><span class="p">(</span><span class="n">schemaname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tablename</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">            </span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">schemaname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tablename</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bloat_size</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_tables</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">schemaname</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pg_catalog&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;information_schema&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="n">bloat_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1048576</span><span class="w"> </span><span class="c1">-- 1MB</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">bloat_size</span><span class="o">/</span><span class="n">table_size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="c1">-- 10% bloat</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">bloat_size</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- 2. Check for unused indexes</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">schemaname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">relname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">table</span><span class="p">,</span>
<span class="w">    </span><span class="n">indexrelname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">index</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">index_size</span><span class="p">,</span>
<span class="w">    </span><span class="n">idx_scan</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">scans</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">pg_stat_user_indexes</span><span class="w"> </span><span class="n">ui</span>
<span class="k">JOIN</span>
<span class="w">    </span><span class="n">pg_index</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ui</span><span class="p">.</span><span class="n">indexrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="n">idx_scan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">-- Index has never been used</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_constraint</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">conindid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span><span class="p">)</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">indisunique</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="c1">-- Not a unique constraint</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>
<hr />
<h2 id="9-transaction-management">9. Transaction Management</h2>
<h3 id="91-acid-properties">9.1 ACID Properties</h3>
<ul>
<li>
<p>Ensure <strong>atomicity</strong> for related operations</p>
</li>
<li>
<p>Maintain <strong>consistency</strong> in database state</p>
</li>
<li>
<p>Implement <strong>isolation</strong> between concurrent transactions</p>
</li>
<li>
<p>Guarantee <strong>durability</strong> of committed transactions</p>
</li>
</ul>
<h3 id="92-transaction-guidelines">9.2 Transaction Guidelines</h3>
<ul>
<li>
<p>Keep transactions <strong>short and focused</strong></p>
</li>
<li>
<p>Set appropriate <strong>isolation levels</strong> for different operations</p>
</li>
<li>
<p>Avoid <strong>long-running transactions</strong></p>
</li>
<li>
<p>Implement <strong>retry logic</strong> for deadlocks</p>
</li>
<li>
<p>Be aware of <strong>transaction costs</strong> in distributed systems</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example transaction handling with retry logic</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">OperationalError</span>

<span class="k">def</span><span class="w"> </span><span class="nf">with_transaction_retry</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a function within a transaction with retry logic.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                    <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="n">max_retries</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="c1"># Exponential backoff</span>

                    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">retry_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="c1"># Usage example</span>

<span class="nd">@with_transaction_retry</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transfer_funds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">from_account_id</span><span class="p">,</span> <span class="n">to_account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
    <span class="c1"># Get accounts with row-level locking</span>

    <span class="n">from_account</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_account_id</span><span class="p">)</span>
    <span class="n">to_account</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">to_account_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">from_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">(</span><span class="s2">&quot;Insufficient funds&quot;</span><span class="p">)</span>

    <span class="c1"># Update balances</span>

    <span class="n">from_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">amount</span>
    <span class="n">to_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span>

    <span class="c1"># Record transaction</span>

    <span class="n">transaction</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span>
        <span class="n">from_account_id</span><span class="o">=</span><span class="n">from_account_id</span><span class="p">,</span>
        <span class="n">to_account_id</span><span class="o">=</span><span class="n">to_account_id</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;completed&#39;</span>
    <span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div>
<hr />
<h2 id="10-scaling-strategies">10. Scaling Strategies</h2>
<h3 id="101-vertical-scaling">10.1 Vertical Scaling</h3>
<ul>
<li>
<p>Increase <strong>hardware resources</strong> for database servers</p>
</li>
<li>
<p>Optimize for <strong>higher concurrency</strong></p>
</li>
<li>
<p>Consider <strong>hardware limitations</strong> and cost implications</p>
</li>
<li>
<p>Monitor <strong>resource utilization</strong> to inform scaling decisions</p>
</li>
</ul>
<h3 id="102-horizontal-scaling">10.2 Horizontal Scaling</h3>
<ul>
<li>
<p>Implement <strong>read replicas</strong> for read-heavy workloads</p>
</li>
<li>
<p>Consider <strong>database sharding</strong> for write-heavy workloads</p>
</li>
<li>
<p>Design for <strong>distributed transactions</strong> if needed</p>
</li>
<li>
<p>Plan for <strong>cross-shard queries</strong> and reporting</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example database cluster configuration</span>

<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-cluster-config</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">postgresql.conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">max_connections = 500</span>
<span class="w">    </span><span class="no">shared_buffers = 4GB</span>
<span class="w">    </span><span class="no">effective_cache_size = 12GB</span>
<span class="w">    </span><span class="no">work_mem = 16MB</span>
<span class="w">    </span><span class="no">maintenance_work_mem = 1GB</span>
<span class="w">    </span><span class="no">max_worker_processes = 8</span>
<span class="w">    </span><span class="no">max_parallel_workers_per_gather = 4</span>
<span class="w">    </span><span class="no">max_parallel_workers = 8</span>
<span class="w">    </span><span class="no">wal_level = replica</span>
<span class="w">    </span><span class="no">max_wal_senders = 10</span>
<span class="w">    </span><span class="no">max_replication_slots = 10</span>
<span class="w">    </span><span class="no">hot_standby = on</span>
<span class="w">    </span><span class="no">hot_standby_feedback = on</span>

<span class="nn">---</span>

<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-primary</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-primary</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
<span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-secrets</span>
<span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
<span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-secrets</span>
<span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">thinkalike</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PGDATA</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data/pgdata</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>

<span class="w">        </span><span class="nt">* containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-primary-data</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-config</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/postgresql/postgresql.conf</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">subPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql.conf</span>
<span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span>

<span class="w">  </span><span class="nt">* metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-primary-data</span>
<span class="w">  </span><span class="w w-Error">  </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;ReadWriteOnce&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">          </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100Gi</span>

<span class="nn">---</span>

<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-replica</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-replica</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
<span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-secrets</span>
<span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
<span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-secrets</span>
<span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">thinkalike</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PGDATA</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data/pgdata</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRIMARY_HOST</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-primary</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span>

<span class="w">        </span><span class="err">*</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash</span>

<span class="w">        </span><span class="err">*</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>

<span class="w">        </span><span class="err">*</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">until pg_isready -h $PRIMARY_HOST -p 5432; do</span>
<span class="w">            </span><span class="no">echo &quot;Waiting for primary to be ready&quot;</span>
<span class="w">            </span><span class="no">sleep 2</span>
<span class="w">          </span><span class="no">done</span>
<span class="w">          </span><span class="no"># Configure as a replica</span>

<span class="w">          </span><span class="no">pg_basebackup -h $PRIMARY_HOST -D $PGDATA -U $POSTGRES_USER -P -v -R</span>
<span class="w">          </span><span class="no">exec postgres</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>

<span class="w">        </span><span class="nt">* containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>

<span class="w">        </span><span class="nt">* name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-replica-data</span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
<span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span>

<span class="w">  </span><span class="nt">* metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-replica-data</span>
<span class="w">  </span><span class="w w-Error">  </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;ReadWriteOnce&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">          </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100Gi</span>
</code></pre></div>
<h3 id="103-database-federation">10.3 Database Federation</h3>
<ul>
<li>
<p>Split databases by <strong>functional domain</strong></p>
</li>
<li>
<p>Define clear <strong>domain boundaries</strong></p>
</li>
<li>
<p>Implement <strong>cross-database communication</strong> patterns</p>
</li>
<li>
<p>Consider eventual consistency challenges</p>
</li>
</ul>
<hr />
<h2 id="11-multi-tenancy">11. Multi-Tenancy</h2>
<h3 id="111-tenancy-models">11.1 Tenancy Models</h3>
<ul>
<li>
<p><strong>Separate databases</strong>: One database per tenant</p>
</li>
<li>
<p><strong>Separate schemas</strong>: One schema per tenant within shared database</p>
</li>
<li>
<p><strong>Shared schema</strong>: Shared tables with tenant identifier</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Isolation</th>
<th>Resource Usage</th>
<th>Management Complexity</th>
<th>Data Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Separate databases</td>
<td>High</td>
<td>High</td>
<td>High</td>
<td>Any size</td>
</tr>
<tr>
<td>Separate schemas</td>
<td>Medium</td>
<td>Medium</td>
<td>Medium</td>
<td>Medium</td>
</tr>
<tr>
<td>Shared schema</td>
<td>Low</td>
<td>Low</td>
<td>Low</td>
<td>Small-Medium</td>
</tr>
</tbody>
</table>
<h3 id="112-implementation-guidelines">11.2 Implementation Guidelines</h3>
<ul>
<li>
<p>Use <strong>tenant identifiers</strong> consistently</p>
</li>
<li>
<p>Implement <strong>row-level security</strong> for shared schema approach</p>
</li>
<li>
<p>Consider <strong>data isolation requirements</strong></p>
</li>
<li>
<p>Plan for <strong>tenant-specific customizations</strong></p>
</li>
<li>
<p>Design for <strong>tenant provisioning/deprovisioning</strong></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">-- Example row-level security implementation for multi-tenancy</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">tenants</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">email</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Enable row-level security</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenant_users</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>

<span class="c1">-- Create a policy that limits access to the current tenant</span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">tenant_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tenant_users</span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;app.current_tenant_id&#39;</span><span class="p">)::</span><span class="nb">INTEGER</span><span class="p">);</span>

<span class="c1">-- Function to set the current tenant context</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">set_tenant_context</span><span class="p">(</span><span class="n">p_tenant_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="n">PERFORM</span><span class="w"> </span><span class="n">set_config</span><span class="p">(</span><span class="s1">&#39;app.current_tenant_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">p_tenant_id</span><span class="p">::</span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="k">FALSE</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- Usage example</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">set_tenant_context</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tenant_users</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Will only see tenant_id = 1 records</span>
</code></pre></div>
<hr />
<h2 id="12-database-documentation">12. Database Documentation</h2>
<h3 id="121-schema-documentation">12.1 Schema Documentation</h3>
<ul>
<li>
<p>Document <strong>table purposes</strong> and relationships</p>
</li>
<li>
<p>Describe <strong>column meanings</strong> and constraints</p>
</li>
<li>
<p>Document <strong>indexing strategy</strong></p>
</li>
<li>
<p>Maintain <strong>entity-relationship diagrams</strong></p>
</li>
<li>
<p>Keep documentation <strong>in sync with schema changes</strong></p>
</li>
</ul>
<h3 id="122-documentation-tools">12.2 Documentation Tools</h3>
<ul>
<li>
<p>Use automated tools to generate schema documentation</p>
</li>
<li>
<p>Include database documentation in the overall project documentation</p>
</li>
<li>
<p>Maintain living documentation that evolves with the schema</p>
</li>
<li>
<p>Document query patterns and access methods</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Example schema documentation generation using SchemaSpy</span>

java<span class="w"> </span>-jar<span class="w"> </span>schemaspy.jar<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-t<span class="w"> </span>pgsql<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-db<span class="w"> </span>thinkalike<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-host<span class="w"> </span>localhost<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-port<span class="w"> </span><span class="m">5432</span><span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-u<span class="w"> </span>documentationuser<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-p<span class="w"> </span>documentationpassword<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-o<span class="w"> </span>./database-docs<span class="w"> </span><span class="se">\</span>

<span class="w">  </span>-dp<span class="w"> </span>postgresql-42.2.23.jar
</code></pre></div>
<hr />
<p><strong>Document Details</strong></p>
<ul>
<li>
<p>Title: Database Design Guidelines</p>
</li>
<li>
<p>Type: Development Guide</p>
</li>
<li>
<p>Version: 1.0.0</p>
</li>
<li>
<p>Last Updated: 2025-04-05</p>
</li>
</ul>
<hr />
<p>End of Database Design Guidelines</p>
<hr />
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
